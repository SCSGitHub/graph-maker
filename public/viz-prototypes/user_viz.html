<!DOCTYPE html>
<meta charset="utf-8">
<head><link href="nouislider/nouislider.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <link rel="stylesheet" href="css/user_viz.css">
    <link href="jquery-ui.css" rel="stylesheet">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
</head>

<body>
    
    <script src="https://d3js.org/d3.v4.min.js"></script>
   <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
   
    <script src="nouislider/nouislider.min.js"></script>
<div class="totalContainer">    
<div class="mainContainer">
   
    <div class="container1" id="tabs">
        <ul>
            <li><a href="#tabs-1">Author</a></li>
            <li><a href="#tabs-2">Paper Details</a></li> 
        </ul>

        <div id="tabs-1">
            <p>Author </p>
        </div>
        <div id="tabs-2">
            <p>Paper Details</p>
        </div>
    </div>
     <label class="yearFilter">Year Filter </label>
    <div class="yearRange" id="slider">
         
    </div>
    
    <div class="ui-widget">
        <div class="labelAuthors"> 
            <label class ="labelClass" for="tags">Author </label>
            </div>       
            <input  id="tags">
    </div> 
    
   
     
<div>
    <button class="filterButton" id="clearfilter" type="button" onclick="clearFilter()">Clear Filters</button>
</div>  
</div>        

<div class="graphContainer">
<svg width="1200" height="1000"></svg>
</div>
</div>    
<script>
    
var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);
    
    
  var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height")

  
  svg.append("rect")
    .attr("width", width)
    .attr("height", height)
    .style("fill", "none")
    .style("pointer-events", "all")
    .call(d3.zoom()
        .scaleExtent([1 / 2, 4])
        .on("zoom", zoomed));

  var zoom = d3.zoom()
    .scaleExtent([1 / 2, 4])
    .on("zoom", zoomed);

    /***
    Apply zoom to the graph
    ***/
  function zoomed() {
        g.attr("transform", d3.event.transform);
  }

  var g = svg.append("g");

  // control the force-directed layout properties
  var simulation = d3.forceSimulation()
    .force("link", d3.forceLink().id(function(d) {
      return d.id;
    }))
    .force("charge", d3.forceManyBody().strength(-10))
    .force("center", d3.forceCenter(width / 2, height / 2));
    
//    .force('link', d3.forceLink(heart.links).distance(0).strength(0.1))

    // define the graph
    /// TODO: read in from separate json/js file
    
  var scaleFactor=6;
    
  var defaultRadius=3;
    
  var topicRadius = 15;


d3.json("data/graph.json", function(error, graph){
    if (error) throw error;
 
  // define visual properties of edges
  var link = g.append("g")
    .attr("class", "links")
    //.selectAll("link")
    .data(graph.nodes)
//    .attr("id", function(d){
//          return 'link' + d.source;
//          })
    //.attr("class", "dataLinks")
    .selectAll("line")
    .data(graph.links)
    .enter().append("line");
 
    
  // define properties of nodes
  var node = g.append("g")
    .attr("class", "nodes")
    .selectAll("circle")
    .data(graph.nodes)
    .enter().append("circle")
    .attr("r", function(d){ 
        if(d.type=='action' || d.type=='why-hard')
        return defaultRadius;
    
        if(d.type=='topic')
            return topicRadius;})
   .attr("class", "dataNodes")
   .attr('id', function(d){ return 'id' + d.id; })
    .style("fill", function(d){
        if(d.type=='action')
            return '#247';
        
        else if(d.type=='why-hard')
            return 'red';
        
        else if(d.type=='topic')
            return '#00BFFF';
    })
    
    .attr('cy', function(d) { return d.distance_from_root; })
    .on("mouseover", function(d) {
       div.transition()
         .duration(200)
         .style("opacity", .9);
       div.html(d.name)
         .style("left", (d3.event.pageX) + "px")
         .style("top", (d3.event.pageY - 28) + "px");
       })
     .on("mouseout", function(d) {
       div.transition()
         .duration(500)
         .style("opacity", 0);
       })
    .on('click', clicked); // set event handler for click event

 
    
  // define visual properties of node labels

 var text = g.append("g")
    .attr("class", "labels")
    .selectAll("text")
    .data(graph.nodes)
    .enter().append("text")
    .attr("class", "dataLabels")
    .attr("font-size","6px")
    .attr("dx", 6)
    .attr('id', function(d){ return 'label' + d.id; })
    .attr("dy", ".15em")
    .text(function(d) { 
        var string = d.name
        
        if (string.length > 5)
            return string.substring(0,7)+'...';
        else
            return string;
       });

  // apply force-directed layout
  simulation
    .nodes(graph.nodes)
    .on("tick", ticked); //

  simulation.force("link")
    .links(graph.links);

    /***
    Recompute force-directed layout after user interaction with nodes
    ***/
  function ticked() {
    link
      .attr("x1", function(d) {
        return d.source.x;
      })
      .attr("y1", function(d) {
        return d.source.y;
      })
      .attr("x2", function(d) {
        return d.target.x;
      })
      .attr("y2", function(d) {
        return d.target.y;
      });

    node
      .attr("cx", function(d) {
        return d.x;
      })
      .attr("cy", function(d) {
        return d.y;
      });

    text.attr("x", function(d) { return d.x; })
        .attr("y", function(d) { return d.y; });
  }
    
 }); 

  // unselect all nodes
  var active = d3.select(null);

  /***
  Control interactions with nodes
  ***/
  function clicked(d) {


    // do nothing if it's the one we already selected
    if (active.node() === this){
      active.classed("active", false);
      return reset();
    }

    // grab the active node(s)
    active = d3.select(this).classed("active", true);
      
      
    if(d.type=='action' || d.type=='why-hard')  {
     //focus around the spot of the selected node(s)
    svg.transition()
      .duration(750)
      .call(zoom.transform,
        d3.zoomIdentity
        .translate(width / 2, height / 2)
        .scale(scaleFactor)
        .translate(-(+active.attr('cx')), -(+active.attr('cy')))
           
      );
       console.log(active);
  }
      
//       if(d.type=='topic')  {
     //focus around the spot of the selected node(s)
//    svg.transition()
//      .duration(750)
//      .call(zoom.transform,
//        d3.zoomIdentity
//        .translate(width / 2, height / 2)
//        .scale(scaleFactor)
//        .translate(positionX(active), positionY(active))
//           
//      );
//        positionX(active);   
       //console.log(active.attr('cx'));
//  }
      
      
      
      // populate info box with relevant info from node
      d3.select("#tabs-1").text(d.authors);
      d3.select("#tabs-2").text(d.id);
  }
    
function positionX(clickedNode){
    //console.log('clcikedNode'+clickedNode);
    var sum=0;
   d3.json("data/node_connections.json", function(d) {
       var str=clickedNode.attr('id');
       var x=clickedNode.attr('cx');
       
       console.log('cx'+x);
    var nodeID=str.substring('id'.length);
    //alert(nodeID);
    var listOfNodes=(d[nodeID]);
    //console.log(listOfNodes);
       
    for(i=0; i< listOfNodes.length; i++){
    listOfNodes[i]= 'id' + listOfNodes[i];
    }
      console.log(listOfNodes); 
       
    for(i=0; i< listOfNodes.length; i++){
        console.log((listOfNodes[i]).attr('cx'));
    }   
//       console.log(sum);
       
});

    
}    

  /***
  Reset to master view
  ***/
  function reset() {
    svg.transition()
      .duration(750)
      .call(zoom.transform,
        d3.zoomIdentity
        .translate(0, 0)
        .scale(1)
      );
  }
    
    
var toggleTime=500;  //set toggle time for transition (in milliseconds)

function triggerFilter(){    

d3.json("data/author_connections.json", function(d) {

var listOfNodes=(d[document.getElementById("tags").value]); 

    for(i=0; i< listOfNodes.length; i++){
    listOfNodes[i]= '#id' + listOfNodes[i];
    }
    
    var stringOfNodes= listOfNodes.toString();
    
    var listOfLabels=(d[document.getElementById("tags").value]);   
     
    var listOfLabels=listOfNodes;    
    
    for(i=0; i< listOfLabels.length; i++){
    listOfLabels[i]= listOfLabels[i].replace('#id', '#label');
       
    }
   
    
    var stringOfLabels= listOfLabels.toString();
      

    filterByName(stringOfNodes, stringOfLabels);
   
});
}
    


function filterByName(nodes, labels){

        d3.selectAll(".dataNodes").transition().duration(toggleTime).style("opacity", 0.3);
        d3.selectAll(".dataLabels").transition().duration(toggleTime).style("opacity", 0.3);
        
        
        d3.selectAll(nodes).transition().duration(toggleTime).style("opacity", 1);
        d3.selectAll(labels).transition().duration(toggleTime).style("opacity", 1);
    
                  
} 
    
function clearFilter(){
     d3.selectAll(".dataNodes").transition().duration(toggleTime).style("opacity", 1); 
     d3.selectAll(".dataLabels").transition().duration(toggleTime).style("opacity", 1); 
}    
    
    
var slider = document.getElementById('slider');

noUiSlider.create(slider, {
	start: [2013, 2017],
	connect: true,
    step: 1,  
	range: {
		'min': 2013,
		'max': 2017
	}
});
    
slider.noUiSlider.on('change', function(){
	var rangeValues=slider.noUiSlider.get(); 
    var min=rangeValues[0];
    var max=rangeValues[1];

   filterByYear(min,max);
    
});      
 

    
function filterByYear(min,max){
    
     console.log(min);
     console.log(max);
   
    d3.json("data/graph.json", function(d) {
       
        var listOfFilteredNodeIDs=[];
        var listOfNodes = d.nodes;
        //console.log(listOfNodes);
        
        for(i=0; i< listOfNodes.length; i++){
            
            
            for(j=0; j<(listOfNodes[i].years).length; j++){
                if(listOfNodes[i].years[j]<max && listOfNodes[i].years[j]>min){
                    listOfFilteredNodeIDs.push(listOfNodes[i].id);
                  
                }
            }
                
        }
        console.log(listOfFilteredNodeIDs);
       
         for(i=0; i< listOfFilteredNodeIDs.length; i++){
            listOfFilteredNodeIDs[i]= '#id' + listOfFilteredNodeIDs[i];
         }
        
         var stringOfNodes= listOfFilteredNodeIDs.toString();
         filterByName(stringOfNodes);    
});
}
    
$( function() {
    $( "#tabs" ).tabs();
  } );
    
    
$( function() {
    var availableTags = [
        "Burke, Moira",
        "Henderson, Aubrey",
        "Agrawala, Maneesh",
        "Laur H. Fisher, MIT",
        "Rajan Vaish, Stanford University",
        "Shirish Goyal, Stanford University",
        "Thomas W. Malone, Massachusetts Institute of Technology",
        "Dang, Steven",
        "Young Ji Kim, Massachusetts Institute of Technology",
        "Aaron Gilbee, Independent Researcher",
        "Forlizzi, Jodi L.",
        "Jeffrey Yu-Ting Lin, Magic Leap",
        "Lykourentzou, Ioanna",
        "Dabbish, Laura",
        "Ding, Xianghua",
        "Ding, Xianghua",
         "Yue Han, Stevens Institute of Technology",
        "Felicia Y Ng, Carnegie Mellon University",
        "Kraut, Robert E.",
        "Mark E Whiting, Carnegie Mellon University",
        "Lim, Ellen",
        "Koutra, Danai",
        "Jasani, Jeel",
        "Kittur, Aniket",
        "Paritosh, Praveen",
        "Chan, Joel",
        "Zhu, Haiyi"
      
    ];
    $( "#tags" ).autocomplete({
      source: availableTags
    });
  } );

    
$( "#tags" ).on( "autocompleteselect", function( event, ui ) {
    triggerFilter();
} );    
  
  

</script>


</body>

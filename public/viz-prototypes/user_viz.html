<!DOCTYPE html>
<meta charset="utf-8">
<head><link href="nouislider/nouislider.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/resources/demos/style.css">
</head>
<style>
  .links line {
    stroke: #aaa;
  }

  .nodes circle {
    pointer-events: all;
    stroke: none;
    stroke-width: 40px;
  }

  .active {
    fill: yellow;
  }
    
    
div.tooltip {
  position: absolute;
  text-align: center;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  pointer-events: none;
}    
</style>

<body>
    
    <script src="https://d3js.org/d3.v4.min.js"></script>
   <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
   
    <script src="nouislider/nouislider.min.js"></script>
    <div id="slider"></div>
   
    <div id="tabs">
    <ul>
    <li><a href="#tabs-1">Author</a></li>
    <li><a href="#tabs-2">Paper Details</a></li>
    
    </ul>
  <div id="tabs-1">
    <p>Author </p>
  </div>
  <div id="tabs-2">
    <p>Paper Details</p>
  </div>
</div>
  
    
<!--
     <div id="dropdownMenu" >
        <select id="dropdownValue"  onchange="triggerFilter()">
  <option value="Paritosh, Praveen">Paritosh</option>
  <option value="Kittur, Aniket">Kittur</option>
  <option value="Chan, Joel">Chan</option>
  <option value="Forlizzi, Jodi L.">Forlizzi</option>
</select>
    </div>
-->
    
<div class="ui-widget">
  <label for="tags">Authors: </label>
  <input  id="tags">
</div> 
<div>
    <button id="clearfilter" type="button" onclick="clearFilter()">Clear Filter</button>
</div>      
    
<svg width="960" height="600"></svg>

<script>
    
function test(){
    alert(document.getElementById("tags").value)
}    
    
var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);
    
    
  var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height")

  
  svg.append("rect")
    .attr("width", width)
    .attr("height", height)
    .style("fill", "none")
    .style("pointer-events", "all")
    .call(d3.zoom()
        .scaleExtent([1 / 2, 4])
        .on("zoom", zoomed));

  var zoom = d3.zoom()
    .scaleExtent([1 / 2, 4])
    .on("zoom", zoomed);

    /***
    Apply zoom to the graph
    ***/
  function zoomed() {
        g.attr("transform", d3.event.transform);
  }

  var g = svg.append("g");

  // control the force-directed layout properties
  var simulation = d3.forceSimulation()
    .force("link", d3.forceLink().id(function(d) {
      return d.id;
    }))
    .force("charge", d3.forceManyBody())
    .force("center", d3.forceCenter(width / 2, height / 2));

    // define the graph
    /// TODO: read in from separate json/js file
    

  var scaleFactor=6;
    
  var defaultRadius=3;
    
  var topicRadius = 15;
    
  var link;
  var node;
  var text;

d3.json("data/graph.json", function(error, graph){
    if (error) throw error;
 
  // define visual properties of edges
  link = g.append("g")
    .attr("class", "links")
    .selectAll("line")
    .data(graph.links)
    .enter().append("line");
 
    
  // define properties of nodes
  node = g.append("g")
    .attr("class", "nodes")
    .selectAll("circle")
    .data(graph.nodes)
    .enter().append("circle")
    .attr("r", function(d){ 
        if(d.type=='action' || d.type=='why-hard')
        return defaultRadius;
    
        if(d.type=='topic')
            return topicRadius;})
    .attr("class", "dataNodes")
    .attr('id', function(d){ return 'id' + d.id; })
    .style("fill", function(d){
        if(d.type=='action')
            return 'green';
        
        else if(d.type=='why-hard')
            return 'red';
        
        else if(d.type=='topic')
            return '#00BFFF';
    })
    .on("mouseover", function(d) {
       div.transition()
         .duration(200)
         .style("opacity", .9);
         div.html(d.name)
         .style("left", (d3.event.pageX) + "px")
         .style("top", (d3.event.pageY - 28) + "px");
       })
     .on("mouseout", function(d) {
       div.transition()
         .duration(500)
         .style("opacity", 0);
       })
    .on('click', clicked); // set event handler for click event

 
    
  // define visual properties of node labels
 text = g.append("g")
    .attr("class", "labels")
    .selectAll("text")
    .data(graph.nodes)
    .enter().append("text")
    .attr("font-size","6px")
    .attr("dx", 6)
    .attr("dy", ".15em")
    .text(function(d) { 
        var string = d.name
        
        if (string.length > 5)
            return string.substring(0,7)+'...';
        else
            return string;
       });

  // apply force-directed layout
  simulation
    .nodes(graph.nodes)
    .on("tick", ticked); //

  simulation.force("link")
    .links(graph.links);

    /***
    Recompute force-directed layout after user interaction with nodes
    ***/
  function ticked() {
    link
      .attr("x1", function(d) {
        return d.source.x;
      })
      .attr("y1", function(d) {
        return d.source.y;
      })
      .attr("x2", function(d) {
        return d.target.x;
      })
      .attr("y2", function(d) {
        return d.target.y;
      });

    node
      .attr("cx", function(d) {
        return d.x;
      })
      .attr("cy", function(d) {
        return d.y;
      });

    text.attr("x", function(d) { return d.x; })
        .attr("y", function(d) { return d.y; });
  }
    
 }); 

  // unselect all nodes
  var active = d3.select(null);

  /***
  Control interactions with nodes
  ***/
  function clicked(d) {


    // do nothing if it's the one we already selected
    if (active.node() === this){
      active.classed("active", false);
      return reset();
    }

    // grab the active node(s)
    active = d3.select(this).classed("active", true);
      
      
//    if(d.type=='action' || d.type=='why-hard')  {
    // focus around the spot of the selected node(s)
    svg.transition()
      .duration(750)
      .call(zoom.transform,
        d3.zoomIdentity
        .translate(width / 2, height / 2)
        .scale(scaleFactor)
        .translate(-(+active.attr('cx')), -(+active.attr('cy')))
           
      );
       console.log(active.attr('cx'));
//  }
      // populate info box with relevant info from node
      d3.select("#tabs-1").text(d.authors);
      d3.select("#tabs-2").text(d.id);
  }

  /***
  Reset to master view
  ***/
  function reset() {
    svg.transition()
      .duration(750)
      .call(zoom.transform,
        d3.zoomIdentity
        .translate(0, 0)
        .scale(1)
      );
  }
    
    
var toggleTime=500;  //set toggle time for transition (in milliseconds)

function triggerFilter(){    

d3.json("data/author_connections.json", function(d) {

var listOfNodes=(d[document.getElementById("tags").value]); 
    
    for(i=0; i< listOfNodes.length; i++){
    listOfNodes[i]= '#id' + listOfNodes[i];
    }
    
    var stringOfNodes= listOfNodes.toString();
    //console.log(stringOfNodes);
    
    filterByName(stringOfNodes);
    //console.log(stringOfNodes);
});
}
    


function filterByName(relevantArray){
    
        //console.log(relevantArray);
         d3.selectAll(".dataNodes").transition().duration(toggleTime).style("opacity", 0.3);
         d3.selectAll(relevantArray).transition().duration(toggleTime).style("opacity", 1);
//    
//        link.style("stroke-opacity", function(o) {
//                return o.source === d || o.target === d ? 1 : opacity;
//            });
                  
} 
    
function clearFilter(){
     d3.selectAll(".dataNodes").transition().duration(toggleTime).style("opacity", 1);
    
}    
    
    
var slider = document.getElementById('slider');

noUiSlider.create(slider, {
	start: [2008, 2016],
	connect: true,
	range: {
		'min': 2000,
		'max': 2020
	}
});
    
slider.noUiSlider.on('change', function(){
	var rangeValues=slider.noUiSlider.get(); 
    var min=rangeValues[0];
    var max=rangeValues[1];

   filterByYear(min,max);
   //console.log(min + max);
    
});      
 

    
function filterByYear(min,max){
    
     console.log(min);
     console.log(max);
   
    d3.json("data/graph.json", function(d) {
       
        var listOfFilteredNodeIDs=[];
        var listOfNodes = d.nodes;
        
        for(i=0; i< listOfNodes.length; i++){
            if(listOfNodes[i].year<max && listOfNodes[i].year>min)
               listOfFilteredNodeIDs.push(listOfNodes[i].id);
        }
        console.log(listOfFilteredNodeIDs);
         //console.log(listOfFilteredNodeIDs.length);
         for(i=0; i< listOfFilteredNodeIDs.length; i++){
            listOfFilteredNodeIDs[i]= '#id' + listOfFilteredNodeIDs[i];
         }
        
         var stringOfNodes= listOfFilteredNodeIDs.toString();
         filterByName(stringOfNodes);    
});
}
    
$( function() {
    $( "#tabs" ).tabs();
  } );
    
$( function() {
    var availableTags = [
      "Kittur, Aniket",
      "Paritosh, Praveen",
      "Chan, Joel",
      "Forlizzi, Jodi L."
    ];
    $( "#tags" ).autocomplete({
      source: availableTags
    });
  } );

    
$( "#tags" ).on( "autocompleteselect", function( event, ui ) {
    triggerFilter();
} );    
  
  

</script>


</body>

<!DOCTYPE html>
<meta charset="utf-8">
<head><link href="nouislider/nouislider.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <!-- <link rel="stylesheet" href="/resources/demos/style.css"> -->
    <link rel="stylesheet" href="css/user_viz.css">
    <link href="jquery-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
</head>

<body>

  <script src="data/papers.js"></script>
  <script src="data/edges.js"></script>
  <script src="data/authors.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <!-- <script src="d3-jetpack.js"></script> -->
  <!-- <script src="d3plus.js"></script> -->
  <script src="nouislider/nouislider.min.js"></script>

  <div class="totalContainer">
    <div class="mainContainer">
      <div class="container1" id="tabs">
        <ul>
          <li><a id="tab-title-papers" href="#tabs-1">Papers <span id="tab-papers-badge" class="badge">0</span></a></li>
          <li><a id="tab-title-authors" href="#tabs-2">Authors <span id="tab-authors-badge" class="badge">0</span></a></li>
        </ul>
        <div id="tabs-1" class="tab-data" style="padding:10px;">
          Click on a node to explore papers in the 'conceptual neighborhood' of the node
        </div>
        <div id="tabs-2" class="tab-data" style="padding:10px;">
          Click on a node to explore authors in the 'conceptual neighborhood' of the node
        </div>

      </div>
      <label class="yearFilter">Filter by year</label>
      <div class="yearRange" id="slider">
      </div>
      <div class="ui-widget">
        <div class="labelAuthors">
          <label class ="labelClass" for="tags">Filter by author </label>
        </div>
        <input id="tags">
      </div>
      <div>
         <select id="drop">
            <option value="1">Level 1</option>
            <option value="2">Level 2</option>
            <option value="3">Level 3</option>
         </select>
       </div>
       <div>
         <button class="filterButton" id="clearfilter" type="button" onclick="clearFilter()">Clear Filters</button>
       </div>
     </div> <!-- End info box container  -->
     <div class="graphContainer">
       <svg class="graph" width=1200 height=1000></svg>
     </div>
   </div>

  <script>

    scaleFactor=6;
    defaultRadius=3;
    topicRadius = 15;
    labelWidth = 25;
    defaultTextLength = 20;
    focusTextLength = 45
    var masterContextNodes;
    var masterContextPaperIDs;
    var focusNodeID = null;
    var masterContextLabels;
    var masterContextLinks;
    var lastClickedNodeID;
    var lastClickedMetadataID;
    isFocusing = false;

    var windowHeight = $(window).height();
    var windowWidth = $(window).width();
    console.log("window viewport height = " + windowHeight.toString());
    console.log("window viewport width = " + windowWidth.toString());
    $('.graphContainer').height(windowHeight-20);
    $('.graphContainer').css("max-height", windowHeight-20);
    $('.graphContainer').width(windowWidth-20);
    $('.graphContainer').css("max-width", windowWidth-20);

    $('.graph').height(windowHeight-20);
    $('.graph').css("max-height", windowHeight-20);
    $('.graph').width(windowWidth-20);
    $('.graph').css("max-width", windowWidth-20);

    $('#tabs-1').css("max-height", windowHeight/3);
    $('#tabs-2').css("max-height", windowHeight/3)

    var div = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

    var svg = d3.select("svg"),
      width = +svg.attr("width"),
      height = +svg.attr("height")

    zoom = d3.zoom()
      .scaleExtent([1 / 2, 4])
      .on("zoom", zoomed);

    function zoomed() {
      g.attr("transform", d3.event.transform);
    }

    svg.append("rect")
      .attr("width", width)
      .attr("height", height)
      .style("fill", "none")
      .style("pointer-events", "all")
      .call(d3.zoom()
        .scaleExtent([1/2, 4])
        .on("zoom", zoomed)
      );

    // svg.transition()
    //   .duration(500)
    //   .call(zoom.transform,
    //     d3.zoomIdentity
    //       .translate(500, 0)
    //       .scale(1/2)
    //   );

    // set the force-directed layout properties
    simulation = d3.forceSimulation()
      .force("link", d3.forceLink().id(function(d) {
        return d.id;
      }))
      .force("charge", d3.forceManyBody().strength(function(d) {
        // return -20;
        return -19-Math.log(d.paperID.length)*250; // give greater repulsion for larger nodes
      }))
      .force("center", d3.forceCenter(width / 2, height / 2));

    // initialize the graph
    var g = svg.append("g");
    d3.json("data/graph.json", function(error, graph){

      if (error) throw error;

      // initialize and draw edges
      var link = g.append("g")
        .attr("class", "links")
        .data(graph.nodes)
        .selectAll("line")
        .data(graph.links)
        .enter().append("line")
        .classed("dataLinks", true)
        .style("stroke", function(d){
          if (d.type=="paper-edge") {
            return "none";
          } else {
            return "#aaa";
          }
        })
        .attr("id", function(d){
          return 'link' + d.id;
        })
        .attr("stroke-dasharray", function(d) {
          if (d.type=="analogy") {
            return "5,5";
          }
        })
        .attr("marker-end", function(d) {
          if (d.type == "analogy" || d.type == "paper-edge") {
            return null;
          } else {
            return "url(#arrow)";
          }
        })
        .attr("opacity", 0.25);

      // initialize and draw nodes
      var node = g.append("g")
        .attr("class", "nodes")
        .selectAll("circle")
        .data(graph.nodes)
        .enter().append("circle")
        .attr("r", function(d){
            if(d.type=='action' || d.type=='why-hard')
            // return defaultRadius;
            return defaultRadius+Math.log(d.paperID.length)*10;

            if(d.type=='paper')
                return topicRadius;})
       .attr("class", "dataNodes")
       .attr('id', function(d){ return 'id' + d.id; })
       .style('opacity', function(d) {
         if (d.paperID.length >= 2) {
           return 0.5+d.paperID.length/10;
         } else if (d.type === "paper") {
           return 0;
         } else {
           return 0.25;
         }
       })
       .style("fill", function(d){
          if(d.type=='action')
            return '#247';
          else if(d.type=='why-hard')
            return 'red';
          else if(d.type=='paper')
            return '#00BFFF';
        })
      .on("mouseover", function(d) { // for tooltips
        div.transition()
          .duration(200)
          .style("opacity", .9);
        div.html(d.name)
          .style("left", (d3.event.pageX) + "px")
          .style("top", (d3.event.pageY - 28) + "px");
      })
      .on("mouseout", function(d) {
        div.transition()
          .duration(500)
          .style("opacity", 0);
      })
      .on("click", function(d) {
         if (d.type == "paper") {
           var focusItemID = d.id;
           if (focusItemID === lastClickedMetadataID&& isFocusing) {
             isFocusing = false;
             clearFocus(focusNodeID);
           } else {
              isFocusing = true;
              focus(focusNodeID, focusItemID, "paper");
              $('.node-metadata').removeClass("selected");
              // $(this).addClass("selected");
              lastClickedMetadataID = focusItemID;
          }
        } else {
          neighboring(d);
        }
      })
        // .on("dblclick", neighboring)
        // .on("click", authorHighlight)
        //.on("click", fade(.1))
        // .on('dblclick', clicked); // set event handler for click event

      svg.append("defs").append("marker")
        .attr("id", "arrow")
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 20)
        .attr("refY", 0)
        .attr("markerWidth", 4)
        .attr("markerHeight", 4)
        .attr("orient", "auto")
        .append("svg:path")
        .attr("d", "M0,-5L10,0L0,5");

      // initialize + draw node labels
      var text = g.append("g")
        .attr("class", "labels")
        .selectAll("text")
        .data(graph.nodes)
        .enter().append("text")
        // .tspans(function(d) {
        //   var string = d.name
        //   if (d.paperID.length >= 2) {
        //     if (string.length > 75) {
        //       var trunc = string.substring(0,77)+'...';
        //       return d3.wordwrap(trunc, 25);
        //     } else {
        //       return d3.wordwrap(string, 25);
        //     }
        //   } else {
        //     return "";
        //   }
        //   // return d3.wordwrap(text, 15);  // break line after 15 characters
        // })
        .attr("class", "dataLabels")
        .attr("font-size", function(d) {
          return parseInt(6+Math.log(d.paperID.length)*10).toString() + 'px';
        })
        .attr("dx", 6)
        .attr('id', function(d){ return 'label' + d.id; })
        .attr("dy", ".15em")
        .text(function(d) {
          var string = d.name
          if (d.paperID.length >= 2) {
            if (string.length > defaultTextLength) {
              return string.substring(0,defaultTextLength+2)+'...';
            } else {
              return string
            }
          } else {
            return "";
          }
        });

      // d3.selectAll("text")
      //   .call(wrap)

      // apply force-directed layout
      simulation
        .nodes(graph.nodes)
        .on("tick", ticked); //

      simulation.force("link")
        .links(graph.links);

      function ticked() {
        link
          .attr("x1", function(d) {
            return d.source.x;
          })
          .attr("y1", function(d) {
            return d.source.y;
          })
          .attr("x2", function(d) {
            return d.target.x;
          })
          .attr("y2", function(d) {
            return d.target.y;
          });

        node
          .attr("cx", function(d) {
            return d.x;
          })
          .attr("cy", function(d) {
            return d.y;
          });

        text.attr("x", function(d) { return d.x; })
            .attr("y", function(d) { return d.y; });
      }

    });

    toggleTime=500;  //set toggle time for transition (in milliseconds)

    var slider = document.getElementById('slider');

    noUiSlider.create(slider, {
    	start: [2013, 2017],
        tooltips: true,
    	connect: true,
        step: 1,
    	range: {
    		'min': 2013,
    		'max': 2017
    	}
    });

    slider.noUiSlider.on('change', function(){
    	var rangeValues=slider.noUiSlider.get();
        var min=rangeValues[0];
        var max=rangeValues[1];

       filterByYear(min,max);

    });

    function filterByYear(min,max){

        d3.json("data/graph.json", function(d) {

            var listOfFilteredNodeIDs=[];
            var listOfNodes = d.nodes;


            for(i=0; i< listOfNodes.length; i++){

                for(j=0; j<(listOfNodes[i].years).length; j++){
                    if(listOfNodes[i].years[j]<=max && listOfNodes[i].years[j]>=min){
                        listOfFilteredNodeIDs.push(listOfNodes[i].id);

                    }
                }

             }

             for(i=0; i< listOfFilteredNodeIDs.length; i++){
                listOfFilteredNodeIDs[i]= '#id' + listOfFilteredNodeIDs[i];
             }

             var stringOfNodes= listOfFilteredNodeIDs.toString();

             nodesByYearFilter=listOfFilteredNodeIDs;

             finalFilter();
        });

    }

    function neighboring(d){

      lastClickedNodeID = d.id;

      var nodeID=d.id;
      focusNodeID = d.id;

      // grab related nodes
      var listOfNodes;
      d3.json("data/node_neighborhoods.json", function(d) {
        if(document.getElementById("drop").value=='1'){
          listOfNodes=d[nodeID][1];
        }

        if(document.getElementById("drop").value=='2'){
          listOfNodes=d[nodeID][1];
          listOfNodes=listOfNodes.concat(d[nodeID][2]);
        }
        if(document.getElementById("drop").value=='3'){
          listOfNodes=d[nodeID][1];
          listOfNodes=listOfNodes.concat(d[nodeID][2]);
          listOfNodes=listOfNodes.concat(d[nodeID][3]);
        }

        listOfNodes=listOfNodes.concat(nodeID);

        listOfNodeIds = [];
        for(var i=0; i<listOfNodes.length; i++){
                    //  listOfNodes[i]= '#id' + listOfNodes[i];
          listOfNodeIds.push('#id' + listOfNodes[i]);
        }
        var stringOfNodes= listOfNodeIds.toString();

        var listOfLabels=listOfNodeIds;
        listOfLabels=listOfLabels.concat('#id'+ nodeID);
        for(i=0; i< listOfLabels.length; i++){
          listOfLabels[i]= listOfLabels[i].replace('#id', '#label');
        }
        var stringOfLabels= listOfLabels.toString();

        var listOfLinks=filterLinks(listOfNodes);
        for(i=0; i< listOfLinks.length; i++){
          listOfLinks[i]= '#link' + listOfLinks[i];
        }
        var stringOfLinks= listOfLinks.toString();

        masterContextNodes = listOfNodeIds;
        masterContextLabels = listOfLabels;
        masterContextLinks = listOfLinks;

        // get paper details
        var meta = paperDetails(listOfNodes);

        // update the viz
        filterByNeighbors(focusNodeID, stringOfNodes, stringOfLabels, stringOfLinks, meta);

        // update author details
        authorDetails(meta['authors']);

      });

    }

    function focus(focusNodeID, focusItemID, focusType) {

      $('.node-metadata').removeClass("focused");

      // add highlights to related nodes
      var listOfNodes;
      var listOfNodeIDs = [];
      var listOfLinks;
      if (focusType === "paper") {
        listOfNodes = papers_to_nodes[focusItemID]
        for (i=0; i<listOfNodes.length; i++) {
          listOfNodeIDs.push("#id" + listOfNodes[i]);
        }
        listOfLinks = filterLinks(listOfNodes);
        for (i=0; i<listOfLinks.length; i++) {
          listOfLinks[i] = "#link" + listOfLinks[i];
        }
        filterByFocus(focusItemID, focusNodeID, listOfNodeIDs.toString(), listOfLinks.toString());
      }

    }

    function paperDetails(nodes){
      var selectedPaperIDs = [];
      var authors=[];
      var authorNames = [];
      var p = document.getElementById("tabs-1");
      p.innerHTML = "";

      for(i=0; i<papers.length; i++) {
        if (findOne(papers[i].nodeIDs, nodes)) {
          selectedPaperIDs.push(papers[i].paperID);
          p.appendChild(newPaper(papers[i]));
          var paperAuthors = papers[i].author_arr
          for (j=0; j<paperAuthors.length; j++) {
            if (authorNames.indexOf(paperAuthors[j]) < 0) {
              authors.push(
                {
                  'name': paperAuthors[j],
                  'title': "CMU HCII Faculty",
                  'url': ""
                }
              );
              authorNames.push(paperAuthors[j]);
            }
          }
        }
      }

      tabBadge = document.getElementById("tab-papers-badge");
      tabBadge.innerText = selectedPaperIDs.length;

      masterContextPaperIDs = selectedPaperIDs;

      return {'papers': selectedPaperIDs, 'authors': authors};

    }

    function authorDetails(authors) {

      var p = document.getElementById("tabs-2");
      p.innerHTML = "";
      authors.forEach(function(author) {
        p.appendChild(newAuthor(author));
      });
      var tabBadge = document.getElementById("tab-authors-badge");
      tabBadge.innerText = authors.length;
    }

    function filterByNeighbors(focusNodeID, nodes, labels, links, meta){

        resetBaseLayer("transition");

        // draw related nodes
        d3.selectAll(nodes)
          .transition()
          .duration(toggleTime)
          .style("opacity", 1)
          .attr("r", function(d){
            if (d.type=='paper') {
              return topicRadius;
            } else {
              return 2+defaultRadius+Math.log(d.paperID.length)*10;
            }
          })

        // draw focus node
        d3.select("#id" + focusNodeID).transition()
          .style("opacity", 1)
          .style("stroke-dasharray", ("5,4"))
          .style("stroke", "orange")
          .style("stroke-width", "3px");

        // draw related links
        d3.selectAll(links)
          .transition()
          .duration(toggleTime)
          .style("opacity", 0.5)
          .style("stroke-width", "3px")

        // show the papers
        var metaPaperIDs = [];
        var metaPaperLabels = [];
        meta.papers.forEach(function(p) {
          metaPaperIDs.push("#id" + p);
          metaPaperLabels.push("#label" + p);
        });

        d3.selectAll(metaPaperIDs.toString())
          .transition()
          .style("opacity", 1);

        // draw related labels (inlcuding paper labels)
        var labelSelector = labels + "," + metaPaperLabels.toString();
        d3.selectAll(labelSelector)
          .transition()
          .duration(toggleTime)
          .style("opacity", 1)
          .attr("font-size", function(d) {
            if (d.type === "paper") {
              return 16;
            } else {
              return parseInt(8+Math.log(d.paperID.length)*10).toString() + 'px';
            }
          })
          .text(function(d) {
            var string = d.name

            if (string.length > focusTextLength) {
              return string.substring(0,focusTextLength+2)+'...';
            } else {
              return string;
            }
          })
          .style("fill", function(d) {
            if (d.type === "paper") {
              return "#00BFFF"
            } else {
              return "black"
            }
          })

          simulation.restart()
    }

    function clearFilter() {

      resetBaseLayer("reset");

      document.getElementById("tabs-1").innerHTML = "Click on a node to explore papers in the 'conceptual neighborhood' of the node";
      document.getElementById("tabs-2").innerHTML = "Click on a node to explore authors in the 'conceptual neighborhood' of the node";

      document.getElementById("tab-authors-badge").innerText = 0;
      document.getElementById("tab-papers-badge").innerText = 0;

      masterContextLinks = [];
      masterContextNodes = [];
      masterContextLabels = [];
      masterContextPaperIDs = [];
      focusNodeID = null;

      // svg.transition()
      //   .duration(500)
      //   .call(zoom.transform,
      //   d3.zoomIdentity
      //   .translate(0, 0)
      //   .scale(1)
      // );

    }

    function filterByFocus(focusItemID, focusNodeID, nodes, links) {

      resetBaseLayer("transition");

      drawHighlightedNodes();

      // make sure the active papers remain visible
      var activePapers = [];
      var activePaperLabels = [];
      masterContextPaperIDs.forEach(function(p) {
        activePapers.push("#id" + p);
        activePaperLabels.push("#label" + p);
      })

      d3.selectAll(activePapers.toString())
        .transition()
        .style("opacity", 1)

      d3.selectAll(activePaperLabels.toString())
        .transition()
        .style("opacity", 1)
        .style("font-size", "16px")
        .text(function(d) {
            var string = d.name
            if (string.length > defaultTextLength) {
              return string.substring(0,defaultTextLength+2)+'...';
            } else {
              return string;
            }
      });

      // highlight the focus node
      d3.select("#id" + focusNodeID).transition()
        .style("stroke-dasharray", ("5,4"))
        .style("stroke", "orange")
        .style("stroke-width", "3px");

      // highlight the focus item
      d3.select("#id" + focusItemID).transition()
        .style("stroke", "orange")
        .style("stroke-width", "3px")

      // highlight the item-related nodes
      d3.selectAll(nodes)
        .transition()
        .duration(toggleTime)
        .style("stroke", "orange")
        .style("stroke-width", "3px")
        .style("opacity", function(d) {
          if (masterContextNodes.indexOf("#id" + d.id) >= 0) {
            return 1
          } else {
            return 0.25 // if outside of the current context
          }
        })

      // highlight the item-related links
      d3.selectAll(links)
        .transition()
        .duration(toggleTime)
        .style("stroke", "orange")
        .style("stroke-width", "2px")

      simulation.restart()
    }

    function clearFocus(focusNodeID) {

      $('.node-metadata').removeClass("selected");

      resetBaseLayer("transition");

      drawHighlightedNodes();

      // make sure the active papers remain visible
      var activePapers = [];
      var activePaperLabels = [];
      masterContextPaperIDs.forEach(function(p) {
        activePapers.push("#id" + p);
        activePaperLabels.push("#label" + p);
      })

      d3.selectAll(activePapers.toString())
        .transition()
        .style("opacity", 1)

      d3.selectAll(activePaperLabels.toString())
        .transition()
        .style("opacity", 1)
        .style("font-size", "16px")
        .text(function(d) {
            var string = d.name
            if (string.length > focusTextLength) {
              return string.substring(0,focusTextLength+2)+'...';
            } else {
              return string;
            }
        })
        .style("fill", function(d) {
          if (d.type === "paper") {
            return "#00BFFF"
          } else {
            return "black"
          }
        })

      // highlight the focus node
      d3.select("#id" + focusNodeID).transition()
        .style("stroke-dasharray", ("5,4"))
        .style("stroke", "orange")
        .style("stroke-width", "3px");

      simulation.restart()
    }

    /**********
    * d3 transition helpers
    **********/

    function resetBaseLayer(purpose) {

      console.log("calling reset base layer");

      // nodes layer
      d3.selectAll(".dataNodes")
        .transition()
        .duration(toggleTime)
        .style("opacity", function(d) {
          if (purpose === "transition") {
            if (d.type === "paper") {
              return 0;
            } else {
              return 0.1;
            }
          } else {
            if (d.paperID.length >= 2) {
              // console.log("big node");
              return 0.5+d.paperID.length/10;
            } else if (d.type === "paper") {
              // console.log("paper!");
              return 0;
            } else {
              // console.log("singleton node");
              return 0.25;
            }
          }
        })
        .attr("r", function(d){
           if(d.type=='action' || d.type=='why-hard')
           // return defaultRadius;
           return defaultRadius+Math.log(d.paperID.length)*10;

           if(d.type=='paper')
               return topicRadius;
        })
        .style("stroke", "none")

        // node labels layer
      d3.selectAll(".dataLabels")
        .transition()
        .duration(toggleTime)
        .style("opacity", function(d) {
          if (purpose === "transition") {
            return 0.1;
          } else {
            if (d.paperID.length >= 2) {
              return 0.5+d.paperID.length/10;
            } else {
              return 0;
            }
          }
        })
        .attr("font-size", function(d) {
          return parseInt(6+Math.log(d.paperID.length)*10).toString() + 'px';
        })
        .style("fill", function(d) {
          if (d.type === "paper") {
            return "#00BFFF"
          } else {
            return "black"
          }
        })
        .text(function(d) {
            var string = d.name
            if (d.paperID.length >= 2) {
              if (string.length > defaultTextLength) {
                return string.substring(0,defaultTextLength+2)+'...';
              } else {
                return string
              }
            } else {
              return "";
            }
         });

       d3.selectAll(".dataLinks")
        .transition()
        .duration(toggleTime)
        .style("opacity", 0.25)
        .style("stroke-width", "1px")
        .style("stroke", function(d){
          if (d.type=="paper-edge") {
            return "none";
          } else {
            return "#aaa";
          }
        })
        .attr("marker-end", function(d) {
          if (d.type == "analogy" || d.type == "paper-edge") {
            return null;
          } else {
            return "url(#arrow)";
          }
        })

    }

    function drawHighlightedNodes() {

      // highlight the nodes
      d3.selectAll(masterContextNodes.toString())
      .transition()
      .duration(toggleTime)
      .style("opacity", 1)
      .attr("r", function(d){
          if(d.type=='paper') {
            return topicRadius;
          } else {
            return 2+defaultRadius+Math.log(d.paperID.length)*10;
          }
       })

       // highlight the focus node
       if (focusNodeID != null) {
          d3.select("#id" + focusNodeID).transition().duration(toggleTime)
            .style("stroke-dasharray", ("5,4"))
            .style("stroke", "orange")
            .style("stroke-width", "3px");
       }

      d3.selectAll(masterContextLabels.toString())
        .transition()
        .duration(toggleTime)
        .attr("font-size", function(d) {
          return parseInt(8+Math.log(d.paperID.length)*10).toString() + 'px';
        })
        .text(function(d) {
          var string = d.name
          if (string.length > focusTextLength) {
            return string.substring(0,focusTextLength+2)+'...';
          } else {
            return string;
          }
        })
        .style("fill", function(d) {
          if (d.type === "paper") {
            return "#00BFFF"
          } else {
            return "black"
          }
        })

      d3.selectAll(masterContextLinks.toString())
        .transition()
        .duration(toggleTime)
        .style("opacity", 0.5)
        .style("stroke", "#aaa")

    }

    /**********
    * Other helpers
    **********/

    function filterLinks(nodes) {
      var edgeIDs = [];
      edges.forEach(function(edge) {
        if (nodes.indexOf(edge.source) >= 0 && nodes.indexOf(edge.target) >= 0) {
          edgeIDs.push(edge.id);
        }
      });
      return edgeIDs;
    }

    function newPaper(item) {
      var d = document.createElement("div");

      d.setAttribute("class", "node-metadata");
      d.setAttribute("id", 'paper-'+item.paperID);
      var title = document.createElement("p");
      title.setAttribute("class", "title");
      // var colTitle = document.createElement("div");
      // colTitle.setAttribute("class", "col-xs-8 col-md-8 title");
      title.appendChild(document.createTextNode(item.title));
      d.appendChild(title);
      var meta = document.createElement("p");
      meta.setAttribute("class", "meta");
      meta.appendChild(document.createTextNode("CSCW " + item.year + " | "));
      // outer.appendChild(colYear);
      // var colLink = document.createElement("div");
      // colLink.setAttribute("class", "col-xs-2 col-md-2 link");
      var a = document.createElement("a");
      a.setAttribute("href", item.url);
      a.setAttribute("target", "_blank");
      a.appendChild(document.createTextNode("more info"));
      // var span = document.createElement("span");
      // span.setAttribute("class", "glyphicon glyphicon-link")
      // a.appendChild(span);
      meta.appendChild(a);
      d.appendChild(meta);

      // d.appendChild(outer);

      return d;

    }

    function newAuthor(item) {
      var d = document.createElement("div");

      d.setAttribute("class", "node-metadata");

      var title = document.createElement("p");
      title.setAttribute("class", "title");
      // var colTitle = document.createElement("div");
      // colTitle.setAttribute("class", "col-xs-8 col-md-8 title");
      title.appendChild(document.createTextNode(item.name));
     d.setAttribute("id", item.name);
      d.appendChild(title);
      var meta = document.createElement("p");
      meta.setAttribute("class", "meta");
      meta.appendChild(document.createTextNode(item.title + " | "));
      // outer.appendChild(colYear);
      // var colLink = document.createElement("div");
      // colLink.setAttribute("class", "col-xs-2 col-md-2 link");
      var a = document.createElement("a");
      a.setAttribute("href", item.url);
      a.setAttribute("target", "_blank");
      a.appendChild(document.createTextNode("more info"));
      // var span = document.createElement("span");
      // span.setAttribute("class", "glyphicon glyphicon-link")
      // a.appendChild(span);
      meta.appendChild(a);
      d.appendChild(meta);

      return d;
    }

    function findOne(haystack, arr) {
      return arr.some(function (v) {
        return haystack.indexOf(v) >= 0;
      });
    }

    function wrap(text, labelWidth) {
      console.log("calling wrap");
      text.each(function() {
        var text = d3.select(this),
            words = text.text().split(/\s+/).reverse(),
            word,
            line = [],
            lineNumber = 0,
            lineHeight = 1.1, // ems
            y = text.attr("y"),
            dy = parseFloat(text.attr("dy")),
            tspan = text.text(null).append("tspan").attr("x", text.attr("x")).attr("y", y).attr("dy", dy + "em");
        while (word = words.pop()) {
          line.push(word);
          tspan.text(line.join(" "));
          if (tspan.node().getComputedTextLength() > width) {
            line.pop();
            tspan.text(line.join(" "));
            line = [word];
            tspan = text.append("tspan").attr("x", text.attr("x")).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
          }
        }
      });
    }

    /*********
    * Unused
    *********/

    // unselect all nodes
    var active = d3.select(null);

    /***
    Control interactions with nodes
    CURRENTLY INACTIVE
    ***/
    function clicked(d) {


      // do nothing if it's the one we already selected
      if (active.node() === this){
        active.classed("active", false);
        return reset();
      }

      // grab the active node(s)
      active = d3.select(this).classed("active", true);


      if(d.type=='action' || d.type=='why-hard')  {
       //focus around the spot of the selected node(s)
      svg.transition()
        .duration(750)
        .call(zoom.transform,
          d3.zoomIdentity
          .translate(width / 2, height / 2)
          .scale(scaleFactor)
          .translate(-(+active.attr('cx')), -(+active.attr('cy')))

        );
         console.log(active);
    }

        d3.select("#tabs-1").text(d.authors);
        d3.select("#tabs-2").text(d.id);

    }

    // var nodesByYearFilter=[];
    // var nodesByAuthorFilter=[];
    //
    // //var allNodesInGraph=[];
    // returnAllNodes();
    //
    //
    //
    // function returnAllNodes(){
    //
    //   d3.json("data/nodes.json", function(d){
    //
    //     for (var i=0; i<d.length; i++){
    //       nodesByYearFilter[i]="#id"+(d[i].id);
    //     }
    //
    //     for (var i=0; i<d.length; i++){
    //       nodesByAuthorFilter[i]="#id"+(d[i].id);
    //     }
    //
    //   });
    //
    // }

    $( function() {
        $( "#tabs" ).tabs();
    });
    //
    //
    // $(function() {
    //     var availableTags = [
    //     "Jodi L. Forlizzi",
    //     "Walter Lasecki",
    //     "Aniket Kittur",
    //     "Alessandro Acquisti",
    //     "Lorrie Faith Cranor",
    //     "Kurt Luther",
    //     "Sophie Vennix",
    //     "Robert E. Kraut",
    //     "Sara Kiesler",
    //     "Laura Dabbish",
    //     "Gabriela Marcu",
    //     "Scott Hudson",
    //     "Nathaniel Fruchter",
    //     "Felicia Y Ng",
    //     "W. Ben Towne",
    //     "Jeffrey M. Rzeszotarski",
    //     "Anita Williams Woolley",
    //     "Steven Dang",
    //     "Manya Sleeper",
    //     "Jeffrey Bigham",
    //     "Anind Dey",
    //     "Winnie Leung",
    //     "Laura A. Dabbish",
    //     "Thomas Garncarz",
    //     "Lixiu Yu",
    //     "Min Kyung Lee",
    //     "Yi-Chia Wang",
    //     "Mark E Whiting",
    //     "Joel Chan",
    //     "Steven P. Dow",
    //     "Anind K. Dey",
    //     "Haiyi Zhu",
    //     "Jeffrey P. Bigham"
    //   ];
    //     $( "#tags" ).autocomplete({
    //       source: availableTags
    //     });
    //   } );

    // $( "#tags" ).on( "autocompleteselect", function( event, ui ) {
    //     FilterByAuthor();
    // } );

    function FilterByAuthor(){

      d3.json("data/author_connections.json", function(d) {

      var listOfNodes=(d[document.getElementById("tags").value]);

          for(i=0; i< listOfNodes.length; i++){
          listOfNodes[i]= '#id' + listOfNodes[i];
          }

          nodesByAuthorFilter=listOfNodes;


          finalFilter();
      });
    }

    function authorHighlight(d){
      console.log(masterContextNodes);
      var nodeAuthors = singleNodePaperDetails(d.id, masterContextNodes);
      singleAuthorDetails(nodeAuthors);

      d3.selectAll(".dataNodes")
      .transition()
      .duration(toggleTime)
      .style("opacity", 0.1)
      .attr("r", function(d){
          if(d.type=='action' || d.type=='why-hard')
          // return defaultRadius;
          return defaultRadius+Math.log(d.paperID.length)*10;

          if(d.type=='topic')
              return topicRadius;
        })
        .style("stroke", "none");

        d3.selectAll(masterContextNodes.toString())
        .transition()
        .duration(toggleTime)
        .style("opacity", 1)
        // .attr("r", defaultRadius+5);
        .attr("r", function(d){
            if(d.type=='action' || d.type=='why-hard')
            // return defaultRadius;
            return 2+defaultRadius+Math.log(d.paperID.length)*10;

            if(d.type=='topic')
                return topicRadius;})

        if (focusNodeID != null) {
            console.log(focusNodeID);
            // console.log("focusNode in paper nodes? " + (nodes.indexOf(focusNodeID) >= 0));
            d3.select("#id" + focusNodeID).transition().duration(toggleTime)
              .style("stroke-dasharray", ("5,4"))
             .style("stroke", "orange")
             .style("stroke-width", "3px");
        }

      d3.select("#id" + d.id).transition()
        .style("stroke", "#D3D3D3")
        .style("stroke-width")

    }

    function intersect(a, b) {
        var t;
        if (b.length > a.length) t = b, b = a, a = t; // indexOf to loop over shorter
        return a.filter(function (e) {
            if (b.indexOf(e) !== -1) return true;
        });
    }

    //    function filterByName(nodes, labels){
    function finalFilter(){

        //console.log(allNodesInGraph);
        console.log("Year="+nodesByYearFilter);
        console.log("Author"+nodesByAuthorFilter);


        var finalListOfLabels=[];
        // var finalListOfLinks=[];


        var finalListOfNodes=intersect(nodesByAuthorFilter, nodesByYearFilter);
        console.log("intersectionOfNodes"+finalListOfNodes);

        var finalStringOfNodes = finalListOfNodes.toString();


        for(i=0; i< finalListOfNodes.length; i++){
            finalListOfLabels[i]= finalListOfNodes[i].replace('#id', '#label');

         }

         var finalStringOfLabels=finalListOfLabels.toString();


         var nodeList = []
         finalListOfNodes.forEach(function(n) {
           nodeList.push(n.replace("#id",""));
         });
         var finalListOfLinks=filterLinks(nodeList);
         for(i=0; i< finalListOfLinks.length; i++){
                  finalListOfLinks[i]= '#link' + finalListOfLinks[i];

         }

         var finalStringOfLinks=finalListOfLinks.toString();


            d3.selectAll(".dataNodes").transition().duration(toggleTime).style("opacity", 0.1);
            d3.selectAll(".dataLabels").transition().duration(toggleTime)
              .style("opacity", 0.2)
              .text(function(d) {
                  var string = d.name

                  if (string.length > 15)
                      return string.substring(0,17)+'...';
                  else
                      return string;
                 });
            d3.selectAll(".dataLinks").transition().duration(toggleTime).style("opacity", 0.1);


            d3.selectAll(finalStringOfNodes).transition().duration(toggleTime).style("opacity", 1);
            d3.selectAll(finalStringOfLabels).transition().duration(toggleTime)
              .style("opacity", 1)
              .text(function(d) {
                  var string = d.name

                  if (string.length > 40)
                      return string.substring(0,42)+'...';
                  else
                      return string;
                 });;
            d3.selectAll(finalStringOfLinks).transition().duration(toggleTime).style("opacity", 0.5);


    }

    function singleNodePaperDetails(nodeID, singleNodeNodes){
      // console.log("calling paperDetails")
      // console.log(papers);
        console.log(singleNodeNodes);
        var combinedNodes = [];
        singleNodeNodes.forEach(function(n) {
          combinedNodes.push(n.replace("#id", ""));
        });
        // var combinedNodes = contextNodes
        // combinedNodes.push(nodeID);
        console.log("number of nodes for singleNodePaperDetails: " + combinedNodes.length);
        var selectedPapers = [];
        var authors=[];
        var authorNames = [];
        for(i=0; i<papers.length; i++){
            console.log(papers[i]);
            console.log(combinedNodes);
            if (findOne(papers[i].nodeIDs, combinedNodes)) {
              console.log("found a match!");
              var copyOf = papers[i];
              if (papers[i].nodeIDs.indexOf(nodeID) >= 0) {
                copyOf['focus'] = 1
              } else {
                copyOf['focus'] = 0;
              }
              selectedPapers.push(copyOf);
              var paperAuthors = papers[i].author_arr
              for (j=0; j<paperAuthors.length; j++) {
                if (authorNames.indexOf(paperAuthors[j]) < 0) {
                  // TODO: do focus computation here
                  var authorObj = {
                      'name': paperAuthors[j],
                      'title': "CMU HCII Faculty",
                      'url': "",
                      'focus': 0
                  }
                  if (authors_to_nodes.hasOwnProperty(paperAuthors[j])) {
                    if (authors_to_nodes[paperAuthors[j]].indexOf(nodeID) >= 0) {
                      authorObj['focus'] = 1;
                    }
                  }
                  authors.push(authorObj);
                  authorNames.push(paperAuthors[j]);
                }
              };
            }
        }
        var p = document.getElementById("tabs-2");
        p.innerHTML = "";

        selectedPapers.sort(function(a, b) { return b.focus-a.focus });
        selectedPapers.forEach(function(paper) {
          var paperDOM = newPaper(paper);
          if (paper.focus == 1) {
            paperDOM.classList.add("focused");
          }
          p.appendChild(paperDOM);
        });
        tabBadge = document.getElementById("tab-papers-badge");
        tabBadge.innerText = selectedPapers.length;

        // set up event listener
        $('.node-metadata').on("click", function(e, target) {
          // console.log("Clicked!");
          // console.log(this);
          var focusItemID = this.id.replace("paper-", "");
          console.log("this metadataID: " + focusItemID);
          console.log("lastClickedMetadataID: " + lastClickedMetadataID);
          if (focusItemID === lastClickedMetadataID && isFocusing) {
            isFocusing = false;
            clearFocus(focusNodeID);
          } else {
            isFocusing = true;
            focus(focusNodeID, focusItemID, "paper");
            $('.node-metadata').removeClass("selected");
            $(this).addClass("selected");
            lastClickedMetadataID = focusItemID;
          }
        });
        return authors;
    }

    function singleAuthorDetails(authors) {

       var p = document.getElementById("tabs-1");
       p.innerHTML = "";
       authors.sort(function(a, b) { return b.focus-a.focus});
       authors.forEach(function(author) {
         var authorDOM = newAuthor(author);
         if (author.focus == 0) {
           authorDOM.classList.add("focused");
         }
         p.appendChild(authorDOM);

       });
       var tabBadge = document.getElementById("tab-authors-badge");
       tabBadge.innerText = authors.length;
    }

    // d3plus.textwrap()
    //   .container(d3.select(".dataLabels"))
    //   .draw();

  </script>

</body>
